<omitted for brevity - same as earlier backend logic>